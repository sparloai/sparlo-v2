---
status: pending
priority: p2
issue_id: "088"
tags: [usage-tracking, reliability, database]
dependencies: []
---

# Clock Skew Vulnerability in Period Boundary Calculation

Usage period calculations rely on client-provided or server-local timestamps, creating potential for clock skew issues.

## Problem Statement

The `get_or_create_usage_period()` function uses `NOW()` for period calculation:

```sql
v_period_start := date_trunc('month', NOW());
```

This can cause issues when:
1. Database and application server clocks drift
2. Requests near month boundaries get assigned to wrong period
3. Usage tracking becomes inconsistent across replicas
4. Edge cases around midnight UTC

## Findings

- Period start calculated from database NOW()
- No explicit timezone handling
- Month boundary edge cases not tested
- Potential for usage to "reset" early or late

## Proposed Solutions

### Option 1: Explicit UTC Handling

**Approach:** Use `NOW() AT TIME ZONE 'UTC'` and document timezone assumptions.

**Pros:**
- Simple fix
- Consistent behavior
- Clear documentation

**Cons:**
- Doesn't address clock drift between services

**Effort:** 30 minutes

**Risk:** Low

---

### Option 2: Idempotent Period Key

**Approach:** Use a period identifier (YYYY-MM) rather than timestamp-based calculation.

**Pros:**
- No clock dependency
- Consistent across all nodes

**Cons:**
- Schema change needed
- Migration of existing data

**Effort:** 2-3 hours

**Risk:** Medium

## Recommended Action

**To be filled during triage.**

## Technical Details

**Affected files:**
- `apps/web/supabase/migrations/20251219000000_add_usage_tracking.sql`

## Acceptance Criteria

- [ ] Timezone handling is explicit and documented
- [ ] Period boundaries work correctly near month end
- [ ] Consistent behavior across database replicas
- [ ] Typecheck passes

## Work Log

### 2025-12-19 - Initial Discovery

**By:** Claude Code (Data Integrity Guardian)

**Actions:**
- Analyzed period boundary calculation
- Identified timezone ambiguity
- Proposed explicit UTC handling

**Learnings:**
- Timestamps in databases need explicit timezone handling
- NOW() behavior varies by PostgreSQL configuration
- Edge cases at period boundaries need testing

## Notes

- IMPORTANT for data consistency
- Test with requests at 23:59:59 and 00:00:00 UTC
- Consider monitoring for period anomalies
